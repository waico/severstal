<html>
    <title></title>

    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    

    <body>
        <div id="app">
            <v-app>
                <v-navigation-drawer app v-model="navigationDrawer" >
                </v-navigation-drawer>
              
                <v-app-bar app>
                    <v-col>
                        <v-btn href="/docs" target="_blank" small>
                            Swagger
                        </v-btn>
                    </v-col>  
                </v-app-bar>
                <v-main>
                    <v-container>

                        <v-row>
                            <v-col class="d-flex">
                                <v-dialog
                                v-model="createDatasetDialog"
                                width="500">
                                <template v-slot:activator="{ on, attrs }">
                                    <v-btn
                                        class="mr-5 mt-2"
                                        fab
                                        dark
                                        small
                                        color="primary"
                                        v-bind="attrs"
                                        v-on="on"
                                        >
                                        <v-icon dark>
                                            mdi-plus
                                        </v-icon>
                                    </v-btn>
                                </template>
                            
                                <v-card>
                                    <v-card-title class="text-h5 grey lighten-2">
                                    Создание набора данных
                                    </v-card-title>
                            
                                    <v-card-text>
                                        <v-text-field
                                            v-model="createDatasetName"
                                            :counter="10"
                                            label="Название"
                                            required
                                        ></v-text-field>
                                        <v-text-field
                                            v-model="createDatasetDescription"
                                            :counter="10"
                                            label="Описание"
                                            required
                                        ></v-text-field>
                                        <v-file-input
                                            v-model="createDatasetFile"
                                            chips
                                            label="Parquet файл"
                                        ></v-file-input>
                                    </v-card-text>
                            
                                    <v-divider></v-divider>
                            
                                    <v-card-actions>
                                    <v-spacer></v-spacer>
                                    <v-btn
                                        color="primary"
                                        text
                                        @click="createDataset"
                                        :disabled="!createDatasetName || !createDatasetFile || createDatasetLoading">
                                        Загрузить
                                    </v-btn>
                                    </v-card-actions>
                                </v-card>
                                </v-dialog>
                                <v-select
                                    v-model="dataset"
                                    :items="datasets"
                                    item-text="name"
                                    item-value="id"
                                    label="Набор данных"
                                    @input="changeDataset"></v-select>
                            </v-col>
                            <v-col>
                                <v-menu
                                    v-model="dateFromMenu"
                                    :close-on-content-click="false"
                                    :nudge-right="40"
                                    transition="scale-transition"
                                    offset-y
                                    min-width="auto">
                                    <template v-slot:activator="{ on, attrs }">
                                    <v-text-field
                                        v-model="dateFrom"
                                        label="Дата с"
                                        prepend-icon="mdi-calendar"
                                        readonly
                                        v-bind="attrs"
                                        v-on="on"
                                    ></v-text-field>
                                    </template>
                                    <v-date-picker
                                        v-model="dateFrom"
                                        @input="dateFromMenu = false"
                                        locale="ru-ru"
                                        ></v-date-picker>
                                </v-menu>
                            </v-col>
                            <v-col>
                                <v-menu
                                    v-model="dateFromMenu"
                                    :close-on-content-click="false"
                                    :nudge-right="40"
                                    transition="scale-transition"
                                    offset-y
                                    min-width="auto">
                                    <template v-slot:activator="{ on, attrs }">
                                    <v-text-field
                                        v-model="dateFrom"
                                        label="Дата по"
                                        prepend-icon="mdi-calendar"
                                        readonly
                                        v-bind="attrs"
                                        v-on="on"
                                    ></v-text-field>
                                    </template>
                                    <v-date-picker
                                        v-model="dateFrom"
                                        @input="dateFromMenu = false"
                                        locale="ru-ru"
                                        ></v-date-picker>
                                </v-menu>
                            </v-col>
                        </v-row>

                        <h3 class="mb-5">Результаты работы моделей</h3>
                        <v-row class="mx-1 mb-4">
                            <v-expansion-panels>
                                <v-expansion-panel
                                    v-for="model in models"
                                    :key="model.id">
                                    <v-expansion-panel-header>
                                        [[ model.name ]]
                                    <template v-slot:actions>
                                        <v-icon color="success">
                                            mdi-check
                                        </v-icon>
                                    </template>
                                    </v-expansion-panel-header>
                                    <v-expansion-panel-content>
                                        [[ model.description ]]
                                    </v-expansion-panel-content>
                                </v-expansion-panel>
                            </v-expansion-panels>
                        </v-row>

                        <v-skeleton-loader v-if="loadingDatasets"
                            class="mx-auto"
                            max-width="350"
                            type="article, actions"
                            elevation="2"></v-skeleton-loader>

                        <v-row>
                            <v-col v-for="equipment in equipments" :key="equipment.id" cols="4">
                                <v-card class="mx-auto">
                                    <v-img
                                        class="white--text align-end"
                                        height="80px"
                                        src="static/exhauster.png"
                                        gradient="to right, rgba(134, 38, 82, 8), rgba(243, 115, 48, 0.5)"
                                        >
                                        <v-card-title>[[ equipment.name ]]</v-card-title>
                                        </v-img>
                                    <v-card-text>
                                        <v-list-item v-for="node in equipment.nodes" :key="node.id">
                                            <v-list-item-title>[[ node.name ]]</v-list-item-title>

                                            <v-list-item-subtitle class="text-right">
                                                OK
                                            </v-list-item-subtitle>
                                        </v-list-item>                                  
                                    </v-card-text>
                                    <v-divider></v-divider>
                                    <v-card-actions>
                                        <v-btn text color="teal accent-4">
                                        Подробнее
                                        </v-btn>
                                    </v-card-actions>
                                </v-card>
                            </v-col>
                        </v-row>
                  </v-container>
                </v-main>
              
                <v-footer app>
                    <v-col>2023 (@) waico for serverstal</v-col>
                </v-footer>
              </v-app>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>

        <script>
            new Vue({
                el: "#app",
                delimiters: ["[[", "]]"],
                vuetify: new Vuetify(),
                data: {
                    navigationDrawer: false,

                    createDatasetDialog: false,

                    createDatasetName: undefined,
                    createDatasetDescription: undefined,
                    createDatasetFile: undefined,
                    createDatasetLoading: false,

                    models: [],

                    loadingDatasets: true,
                    datasets: [],
                    dataset: undefined,
                    equipments: [],

                    dateFromMenu: false,
                    dateFrom: undefined // (new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000)).toISOString().substr(0, 10),
                },
                methods: {
                    loadDatasets() {
                        axios.get("/datasets/").then((response) => {
                            this.loadingDatasets = false;
                            this.datasets = response.data;
                            this.dataset = this.datasets[0];

                            this.getFirstDate();
                        });
                    },
                    loadModels() {
                        axios.get("/models/").then((response) => {
                            this.models = response.data;
                        });
                    },
                    loadEquipments() {
                        axios.get("/equipment/").then((response) => {
                            this.loadingDatasets = false;
                            this.equipments = response.data;
                        });
                    },
                    changeDataset(id) {
                        console.info(id)
                    },
                    createDataset() {
                        axios.post('/datasets/', { name: this.createDatasetName, description: this.createDatasetDescription }).then((response) => {
                            var dataset = response.data
                            
                            var formData = new FormData();
                            formData.append('file', this.createDatasetFile)

                            axios.post(`/datasets/${dataset.id}/upload`, formData, {
                                headers: { 'content-Type': 'multipart/form-data' }
                            }).then((response) => {
                                this.createDatasetName = undefined;
                                this.createDatasetDescription = undefined;
                                this.createDatasetFile = undefined;
                                this.createDatasetDialog = false;

                                this.dataset = response.data
                                this.datasets.push(this.dataset)
                            });
                        });
                    },
                    getFirstDate() {

                        query = `SELECT DT FROM "${this.dataset.path}" ORDER BY DT DESC LIMIT 1`;
                        axios.get(`/datasets/${this.dataset.id}`, { params: {query: query} }).then((response) => {
                            var dt = JSON.parse(response.data).DT[0];
                            this.dateFrom = new Date(dt).toISOString().substr(0, 10)
                        });
                    }
                    
                },
                mounted() {
                    this.loadDatasets();
                    this.loadEquipments();
                    this.loadModels();
                }
            });
        </script>
    </body>

</html>